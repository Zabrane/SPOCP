<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=iso-8859-1">
<TITLE>SPOCP Administrators manual</TITLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<H1>SPOCP Administrators manual</H1>
<P>Document Status: Project document, last updated
2004-02-23<BR>Authors: Roland Hedberg and Torbj&ouml;rn Wiberg
</P>
<H1>Content</H1>
<OL>
<LI><P STYLE="margin-bottom: 0in"><A HREF="#intro">Introduction</A> 
</P>
<LI><P STYLE="margin-bottom: 0in"><A HREF="#native">Using the native
SPOCP server</A> 
</P>
<LI><P STYLE="margin-bottom: 0in"><A HREF="#pam">Using Spocp as a
PAM module</A> 
</P>
<LI><P STYLE="margin-bottom: 0in"><A HREF="#apache_mod">Spocp as
access control for a Apache server</A> 
</P>
</OL>
<H1><A NAME="intro"></A>0. Introduction</H1>
<P>This document assumes some basic knowledge on how S-expressions
are used to manage authorization. If you know very little about this
you would do well to read <A HREF="draft-hedberg-spocp-sexp-00.html">Introduction to
S-expressions</A> before you dwell deeper into this document.<BR>The
next thing is that you will probably not be interested in all of this
document since someone already have decided which authorization setup
you should use. If that is not the case, please read <A HREF="implement.html">The
implementers guide</A> to get more information on pro and cons of
choosing one setup before another.<BR>If you are still with me at
this point you are definitely interested in how to set up a
authorization system for you application. So after reading through
<A HREF="rules.html">creating rules</A> you can skip to the section
that deals with your specific setup.</P>
<P>Through out this document I will use the canonical S-expression
format when describing exactly what is produced. In duscussions on
transformations in some case I have choosen to use the advanced
format since that is easier to read. 
</P>
<P>All of the different implementations sofar loads the rules they
are going to work with from a textfile when they start. If you are not
using the administrative interface to keep the rules updated, you have 
to modify the text file and then restart the server when you want to update
the rule set.
</P>
<H1><A NAME="native"></A>1. Using the native SPOCP serve</H1>
<H2>1.0 Introduction</H2>
<P> The Spocd server can listen on Internet ports
as well as unix domain sockets and as protocol it can presently only
used TCP. In the future UDP might also be supported. 
</P>
<H2>1.1 Configuration file</H2>
<H3>1.1.0 Server part</H3>
<P>The server has to know a couple of things when it starts and these
things are supposed to be learnt from the configuration file.<BR>The
format of the configuration file is as follows: 
</P>
<PRE>
 line    = ( &quot;[&quot; keyword &quot;]&quot; / *UTF8 ) CRLF

 keyword = &quot;calist&quot; / &quot;certificate&quot; / &quot;dhfile&quot;
           / &quot;entropyfile&quot; / &quot;logfile&quot; / &quot;passwd&quot; / &quot;port&quot;
           / &quot;privatekey&quot; / &quot;rulefile&quot; / &quot;threads&quot; / &quot;timeout&quot;
           / &quot;unixdomainsocket&quot; / &quot;sslverifydepth&quot; / &quot;pidfile&quot;
           / &quote;maxconn&quote;

  CRLF    = %x0D [ %x0A ]

  UTF8    = %x01-09 / %x0B-0C / %x0E-7F / UTF8-2 / UTF8-3 / UTF8-4 / UTF8-5 / UTF8-6
  UTF8-1  = %x80-BF
  UTF8-2  = %xC0-DF UTF8-1
  UTF8-3  = %xE0-EF 2UTF8-1
  UTF8-4  = %xF0-F7 3UTF8-1
  UTF8-5  = %xF8-FB 4UTF8-1
  UTF8-6  = %xFC-FD 5UTF8-1
</PRE>
<P>
<DL>
<DT><B>calist</B></DT>
<DD STYLE="margin-bottom: 0.2in">
File of PEM-encoded Server CA Certificates that can be used to
verifiy client certificates 
</DD>
<DT><B>certificate</B></DT>
<DD STYLE="margin-bottom: 0.2in">
The file that contains the signed certificate that belongs to the
SPOCP server 
</DD>
<DT><B>dhfile</B></DT>
<DD STYLE="margin-bottom: 0.2in">
A Diffie-Hellman parameter file 
</DD>
<DT><B>entropyfile</B></DT>
<DD STYLE="margin-bottom: 0.2in">
A file which can be used to feed the randomness function. On a Linux
system that has been running for a while this is almost never
needed. 
</DD>
<DT><B>logfile</B></DT>
<DD STYLE="margin-bottom: 0.2in">
Where SPOCP should write the logfile entries 
</DD>
<DT><B>passwd</B></DT>
<DD STYLE="margin-bottom: 0.2in">
The password necessary to unlock the private key of the SPOCP
server. If this not provided and the private key is protected by a
password then the server will ask for the password on startup.
Something which might be feasible/necessary/correct in some
circumstances. In others it is completely unworkable 
</DD>
<DT><B>pidfile</B></DT>
<DD STYLE="margin-bottom: 0.2in">
Where the server should write the process Id of the server 
</DD>
<DT><B>port</B></DT>
<DD STYLE="margin-bottom: 0.2in">
Which Internet port SPOCP should listen on. If this keyword is
defined the keyword &quot;unixdomainsocket&quot; must not be defined
and vice versa. 
</DD>
<DT><B>privatekey</B></DT>
<DD STYLE="margin-bottom: 0.2in">
The file that contains the privatekey that should be used by this
SPOCP server, this file can be the same as the one specified for the
certificate. But we strongly discourage this practice. Instead we
recommend you to separate the Certificate and the Private Key 
</DD>
<DT><B>rulefile</B></DT>
<DD STYLE="margin-bottom: 0.2in">
Where the file containing the SPOCP rules are placed. 
</DD>
<DT><B>sslverifydepth</B></DT>
<DD STYLE="margin-bottom: 0.2in">
From the OpenSSL documentation: This directive sets how deeply
mod_ssl should verify before deciding that the clients don't have a
valid certificate. 
</DD>
<DD STYLE="margin-bottom: 0.2in">
The depth actually is the maximum number of intermediate certificate
issuers, i.e. the number of CA certificates which are max allowed to
be followed while verifying the client certificate. A depth of 0
means that self-signed client certificates are accepted only, the
default depth of 1 means the client certificate can be self-signed
or has to be signed by a CA which is directly known to the server
(i.e. the CA's certificate is under). 
</DD>
<DT><B>threads</B></DT>
<DD STYLE="margin-bottom: 0.2in">
The number of threads the server will use to service requests. This
number is static, that is it will not change over time depending on
load. 
</DD>
<DT><B>timeout</B></DT>
<DD STYLE="margin-bottom: 0.2in">
The inactivity timeout. If a client has been silent for this long
(seconds) on a connection the server will unilaterly close down the
connection. If set to 0, the server will never close the connection on
a client. Default is 30. 
</DD>
<DT><B>unixdomainsocket</B></DT>
<DD STYLE="margin-bottom: 0.2in">
Which unix domain socket spocp should listen on. 
</DD>
</DL>
<H3>
1.1.2 Plugin part</H3>
<P>The native server handles what we call boundary conditions through
the use of plugins. Plugins are dynamically loaded software modules
that is loaded at startup. 
</P>
<P>Since we don't know and can't guess what kind of plugins there are
going to be in the future we have only defined how to tell the
server about plugins. 
</P>
<P>You are suppost to use the construct: 
</P>
<PRE>  &quot;[&quot; pluginname &quot;:&quot; key &quot;]&quot;</PRE><P>
There are a couple of keys that we have defined and then you are free
to define more for managing the configuration of your backend. The
ones we have defined are: 
</P>
<DL>
<DT><B>filename</B> 
</DT><DD STYLE="margin-bottom: 0.2in">
The absolute pathname to the dynammic software module implementing
the backend 
</DD><DT>
<B>test</B> 
</DT><DD STYLE="margin-bottom: 0.2in">
The function that should be invoked when this backend is used to
evauate a boundary condition 
</DD><DT>
<B>init</B> 
</DT><DD STYLE="margin-bottom: 0.2in">
A function that should be run by the server on startup. This is if
the backend needs to do some initialization before it is used for
evaluation the first time 
</DD><DT>
<B>cachetime</B> 
</DT><DD STYLE="margin-bottom: 0.2in">
Definitions of the cachetime to use for different backends. The
first argument is the number of seconds, the second a string which
will be matched agains the string defining the arguments of the
backend after the variable substitution 
</DD>
<DT><B>poolsize</B></DT>
<DD>Every plugin can have a connection pool connected to it. It can use
this pool to store open connections to information resources it uses for
the future. This instead of closing and opening connections for each
query. Here you can define how big the pool should be for each plugin
separately. If you do not define a poolsize for a plugin, that plugin
will not be able to store connections for later use</DD>
</DL>
<H3>
1.1.3 Example</H3>
<PRE>[certificate]
/usr/local/spocp/certs/spocpserver.pem

[privatekey]
/usr/local/spocp/certs/spocpserver.pem

[passwd]
NewKey

[calist]
/usr/local/spocp/certs/cacert.pem

[dhfile]
/usr/local/spocp/certs/dh.pem

[entropyfile]
/var/log/messages

[logfile]
/var/log/spocp

[port]
3456

[rulefile]
/usr/local/spocp/test/pam/pam

[clients]
/pam : q : : C=SE, O=Catalogix, OU=Pam Client,.*
: qlarb : 213.79.154.114
/ftp : q : 213.79.154.117
/www : q : 130.239.17.0/255.255.255.0

[threads]
5

[timeout]
30

[flatfile:filename]
/usr/local/spocp/lib/libflatfileplugin.so

[flatfile:test]
flatfile_test

[flatfile:cachetime]
3600  /
10    /home/roland/
180   /etc
60    /etc/passwd</PRE><H2>

1.2 Commandline options</H2>
When you start the server you probably want to tell it where to find the configuration
file. The default is to look for a file named "config" in the directory where you stood
when you started the program. 
<PRE> spocd [-d num][-f file][-h]
 num   = 1*digit
 digit = %30-39
 file  = 1*UTF8 ; filename</PRE>

The '-d' option allows you to decide how much should be logged. It works like this:
1-7 is the loglevel (0 = ONLY emergencies,..., 7=debug). If you have set DEBUG as the level 
you can get even more information by specifying which part of the code that should log
debug information ( 16 = PARSE, 32 = STORE, 64 = MATCH, 128 = BOUNDARY CONDITIONS and
256 = SERVER ). So 511 should given you everything it can produce and it's quite a lot.

<H2><A NAME="rulefile"></A>1.3 Rulefile format</H2>
<P>A formal definition: 
</P>
<PRE> 
  spec       = line *( BSLASH CR line ) CR
  line       = ( rule / comment / "" / definition / bconddef / include ) 
  rule       = [ path ] sexp [ bcond [ blob ]]
  element    = sexp / atom / constant
  sexp       = "(" atom *element ")"
  blob       = atom 
  atom       = len ":" val
  constant   = "$$(" key ")"
  key        = 1*(%x2A-7E)
  comment    = "#" *UTF8  
  definition = key *SP "=" *SP 1*( sexp )
  bconddef   = key *SP ":=" *SP 1*( sexp )
  SP         = %x20 / %x09                      ; space or tab
  DIGIT      = %x30-39
  len        = %x31-39 *( DIGIT )
  val        = 1*( UTF8 / pair )
  include    = ";include" filename              ; reference to another rule file

  pair       = "\" ( "\" / hexpair )
  hexpair    = hexchar hexchar
  hexchar    = DIGIT / "A" / "B" / "C" / "D" / "E" / "F"
               / "a" / "b" / "c" / "d" / "e" / "f"

  path       = "/" *( dir "/" ) ;
  dir        = 1*pchar 
  pchar      = DIGIT / 0x41-5A / 0x61-7A / %x2E

  bcond      = bcexp / bcomp
  bcomp      = and / or / not / ref
  ref        = "(3:ref" bcname ")"
  and        = "(3:and" 2*( bcomp ) ")"
  or         = "(2:or" 2*( bcomp ) ")"
  not        = "(3:not" bcomp ")"
  CR         = %x0D
  BSLASH     = %x5C         
</PRE>
<P>
A unformal definition: <BR>A rule file consists of zero or more
constant definitions, definitions of boundary conditions,  comments and rules. Constant definitions binds
a value to a key, these keys can then later on appear in other
constant definitions or rule definitions. Like this: 
</P>
<PRE>docroot = 3:usr5:local3:apache6:htdocs
friends = (1:*3:set5:diego3:ton4:javi4:sara)
mydocs  = $$(docroot)6:roland
#
(5:spocp(8:resource$$(docroot))(6:action1:0)(subject))
(5:spocp(8:resource$$(mydocs))(6:action1:0)(subject(4:user$$(friends)))</PRE><P>
It is important to remember that the constants are replaced <EM>when</EM>
they appear in a rule or a definition. So constant definitions has to
appear before they are used. 
</P>
<P>Furthermore, constants can <b>not</b> be redifined, a new constant definition
with a key that is already bound will be logged as an error and the value
bound to the key will not be replaced. 
</P>
<P>Inclusion of other files are done where the reference to them
appear in the text. 
</P>
<P>Rules can be divided into rulesets, they way to ackomplish this is
to prepend the ruledefinition itself with a path name. 
</P>
<b>Note:</b>rules defined in the rulefile has to be in the canoncial s-expression format.
If the rules contain non-printable characters these have to be escaped. If characters are escaped
please be aware that the length of the atom specified in the length field has to be the length 
after the atom is deescaped.<p>
So it should be "(6:pling\07)" and not "(8:pling\07)".
<p>
<HR>
<H2><A NAME="pam"></A>2. Spocp as a Pluggable Authentication Module
(PAM) for Linux</H2>
<H3>2.1 Account queries to S-expression conversion</H3>
<P>The information presented to the PAM module are service requested,
on what host,by who ( uid and gid ) and finally from where the
request came. It might come from a tty or a completely other host. 
</P>
<P>From this information, S-expression of this form is constructed
(it is are wrapped into several lines to make it more readable) : 
</P>
<PRE>(5:spocp
  (8:resource&lt;host&gt;)
  (6:action&lt;service&gt;)
  (7:subject(3:uid&lt;uid&gt;)(3:gid&lt;gid&gt;)(4:host&lt;wherefrom&gt;)))</PRE><P>
<BR>So a 'realworld' example of a query would then be (also wrapped):
</P>
<PRE>(5:spocp
  (8:resource6:theano)
  (6:action7:useradd)
  (7:subject(3:uid3:501)(3:gid3:100)(4:host5:pts/2)))</PRE><P>
<BR>And one could imaging having a matching rule that could be : 
</P>
<PRE>(5:spocp
  (8:resource6:theano)
  (6:action7:useradd)
  (7:subject(3:uid(1:*5:range2:ge3:5002:le:600))(3:gid)(4:host(1:*6:prefix4:pts/))))</PRE><P>
<BR>The interpretation of this rule is that anyone with a user id
between 500 and 600 connected to the machine through a tty with a
name starting with &quot;pty/&quot; is allowed to run the command
'useradd'. If this was the only rule defined and used then root would
not be able to run 'useradd' ! 
</P>
<H2>2.2 PAM configuration file format</H2>
<P>PAM separates the tasks of authentication into four independent
management groups: 
</P>
<UL>
<LI><P STYLE="margin-bottom: 0in">account management; 
</P>
<LI><P STYLE="margin-bottom: 0in">authentication management; 
</P>
<LI><P STYLE="margin-bottom: 0in">password management; 
</P>
<LI><P>and session management. 
</P>
</UL>
<P>SPOCP is used for the <EM>account</EM>management, which is
basically for answering queries like 
</P>
<UL>
<LI><P STYLE="margin-bottom: 0in">has the user's password expired? 
</P>
<LI><P>is this user permitted access to the requested service? 
</P>
</UL>
<P>The second question to me looks more like authorisation than
authentication but then what is in a word ? <BR>Anyway this type of
questions are the rationale for using a authorization system like
spocp in the PAM context. 
</P>
<P>There are two places where information about when and how a module
should be used. Either in /etc/pam.conf or in files in the directory
/etc/pam.d .If the directory exists then the file is ignored. 
</P>
<P>The format of each rule is a space separated collection of tokens,
the first three being case-insensitive: 
</P>
<PRE STYLE="margin-bottom: 0.2in">  service  type  control  module-path  module-arguments</PRE><P>
The syntax of files contained in the /etc/pam.d/ directory, are
identical except for the absence of any service field. In this case,
the service is the name of the file in the /etc/pam.d/ directory.
This filename must be in lower case. 
</P>
<P>More information on PAM can be gotten on any Linux system by
running &quot;<B>man pam</B>&quot; 
</P>
<P>Below is a example on how to configure PAM to use the spocp module
when authenticating the use of the command <EM>useradd</EM>. This is
the content of the file /etc/pam.d/useradd : 
</P>
<PRE>#%PAM-1.0
auth     sufficient     pam_rootok.so
auth     required       pam_permit.so
account  required       pam_spocp.so   \
        spocpserver=theano.catalogix.se:3456 \
        ssl \
        privatekey=/usr/local/spocp/certs/pam.pem \
        calist=/usr/local/spocp/certs/cacert.pem passwd=pampem \
        certificate=/usr/local/spocp/certs/pam.pem
account  required       pam_permit.so
password required       pam_permit.so
session  required       pam_deny.so</PRE><P>
Notice that if the PAM module should use TLS to protect the
communication with the SPOCP server then all relevant information,
like where the certificate and private key of the client are place,
has to be provided in the configuration file. If <EM>ssl</EM> is not
defined as an argument then TLS is not used.<BR>So, as another
example, if the PAM module is suppost to talk to the server over a
unix domain socket on the same machine ( in which case TLS seems
quite unnecessary ) the spocp line in the configuration file would
become: 
</P>
<PRE STYLE="margin-bottom: 0.2in">account  required       pam_spocp.so    spocpserver=/tmp/spocp </PRE><H1>
<A NAME="apache_mod"></A>3. Spocp as accesscontrol system for a
Apache server</H1>
<H2>3.1 Apache configuration: (httpd.conf)</H2>
<P>This directive is suppost to be used inside &lt;Directory&gt; or
&lt;Location&gt; within *.conf files. It can not be used in
.htaccess. &lt;/Location&gt;&lt;/Directory&gt; 
</P>
<P>Spocp domain serverlocation 
</P>
<DL>
<DT>domain 
</DT><DD STYLE="margin-bottom: 0.2in">
a tag to be used to group several directories, and to let them all
be governed by the same set of rules. 
</DD><DT>
serverlocation 
</DT><DD STYLE="margin-bottom: 0.2in">
serverlocation is where the spocp server can be found, this is
either host:port ( remember there is no default spocp port ) or a
unix domain socket specification. 
</DD></DL>
<H2>
3.2 Defining the Spocp rules</H2>
<P>There are 5 different cases when it comes to http requests: 
</P>
<OL>
<LI><P STYLE="margin-bottom: 0in">http without authentication 
</P>
<LI><P STYLE="margin-bottom: 0in">http with authentication 
</P>
<LI><P STYLE="margin-bottom: 0in">https without authentication 
</P>
<LI><P STYLE="margin-bottom: 0in">https with user authentication 
</P>
<LI><P>https with client certificate authentication 
</P>
</OL>
<P>Depending on which one is in use, the webserver has access to
different types of information. This means that the webserver will
build different Spocp queries depending on which case is in use. The
name of the resource that is requested is always present together
with the spocp domain name. Apart from that the following information
is present in the different cases: 
</P>
<DL>
<DT><B>http without authentication</B> 
</DT><DD>
client ip address and 
</DD><DD STYLE="margin-bottom: 0.2in">
possibly client domain name 
</DD><DT>
<B>http with authentication</B> 
</DT><DD>
client ip address, 
</DD><DD>
possibly client domain name, 
</DD><DD>
user name, 
</DD><DD>
authentication domain name and 
</DD><DD STYLE="margin-bottom: 0.2in">
authentication type 
</DD><DT>
<B>https without authentication</B> 
</DT><DD>
client ip address, 
</DD><DD>
possibly client domain name and 
</DD><DD STYLE="margin-bottom: 0.2in">
whether SSLv2, SSLv3 or TLSv1 is used. 
</DD><DT>
<B>https with user authentication</B> 
</DT><DD>
client ip address, 
</DD><DD>
possibly client domain name, 
</DD><DD>
user name, 
</DD><DD>
authentication domain name, 
</DD><DD>
authentication type and 
</DD><DD STYLE="margin-bottom: 0.2in">
whether SSLv2, SSLv3 or TLSv1 is used. 
</DD><DT>
<B>https with client certificate authentication</B> 
</DT><DD>
client ip address, 
</DD><DD>
possibly client domain name, 
</DD><DD>
subjectname from the client certificate, 
</DD><DD>
issuername from the client certificate, 
</DD><DD>
and whether SSLv2, SSLv3 or TLSv1 is used. 
</DD><DD STYLE="margin-bottom: 0.2in">
If SSLOption +fakeBasicAuth is specified the client certificate
subjectname also appears as user name. 
</DD></DL>
<P>
Whether domain name will be available or not depends on what DNS
contains. The module will do a DNS lookup and then do a double
reverse lookup. The result is the (double reverse checked) hostname,
or NULL if any of the lookups fail. The construction of the Spocp
query follows the default 3-tuple contruct with separate parts for
resource, action and subject.<BR>The different part are constructed
as follows : 
</P>
<DL>
<DT><B>resource:</B> 
</DT><DD STYLE="margin-bottom: 0.2in">
spocpdomain and resourcename 
</DD><DT>
<B>action:</B> 
</DT><DD>
action as number, 0 (GET), 1(PUT), 2(POST), and so on 
</DD><DD STYLE="margin-bottom: 0.2in">
and access control (1) or authorization check 
</DD><DT>
<B>source:</B> 
</DT><DD STYLE="margin-bottom: 0.2in">
ipnumber hostname [sslversion [issuerDN subjectDN]] [user authname
authtype] 
</DD></DL>
<P>
A typical Spocp query (split into several lines to make it more
readable) 
</P>
<PRE>  (5:spocp
    (8:resource
     3:www                              ; spocp domain
     10:index.html1:-                   ; resource name (index.html)
    )
    (6:action1:01:0)                    ; 0 = GET, 0 = access check
    (7:subject
      (2:ip14:213.79.154.114)           ; client ip
      (4:host2:se9:catalogix6:theano)   ; client hostname
    )
  )</PRE><P>
And after a https request, after authentication has completed. No
client certificate demanded. 
</P>
<PRE>  (5:spocp
    (8:resource
     9:internal                         ; spocp domain
     9:internal10:index.html1:-         ; resource name (internal/index.html)
    )
    (6:action1:01:1)                    ; 0 = GET, 1 = authorization check
    (7:subject
      (2:ip14:213.79.154.114)           ; client ip
      (4:host2:se9:catalogix6:theano)   ; client hostname
      (7:sslvers3:300)                  ; SSLv3
      (4:user6:roland)
      (8:authname6:secret)
      (8:authtype5:Basic)
    )
  )</PRE><P>
<EM><B>Beware!</B></EM> that in Apache access control really consists
of tree parts; access control, identity control and authorization
control. This means that if you have a protected part of you
webserver where you demand authentication and authorization. Then you
will get two Spocp queries. The first a access check ( without any
user, authtype and authname specifications ) and the second one a
authorization check with user, authtype and authname. The mod_spocp
implementation allows you to distinguish between these by adding a
'0' element to the action list if it is a access check and a '1' if
it is a authorisation check. 
</P>
<H2>3.2 A simple example 
</H2>
<P>Given a httpd.conf with the following parts: 
</P>
<PRE>DocumentRoot &quot;/srv/www/htdocs&quot;

&lt;Directory &quot;/srv/www/htdocs&quot;&gt;
    Options Indexes FollowSymLinks MultiViews
    AllowOverride None

    Spocp docs /tmp/spocp
&lt;/Directory&gt;</PRE><P>
Having the simple ruleset:
<BR>(5:spocp(8:resource4:docs)(6:action1:0)(7:subject)) <BR>in the
Spocp server would allow anyone access to the top directory. 
</P>
<P>So a request for http://127.0.0.1/index.html, which would generate
the query: 
</P>
<PRE>(5:spocp
  (8:resource4:docs10:index.html1:-)
  (6:action1:0)
  (7:subject(2:ip9:127.0.0.1)(4:host9:localhost))
)</PRE><P>
would be permitted. 
</P>
<P>Let us add another directory to the HTTP server, 
</P>
<PRE>&lt;Directory /srv/www/htdocs/local&gt;
  AuthType Basic
  AuthName company
  AuthUserFile /etc/httpd/passwd
  Require valid-user
  Spocp protect /tmp/spocp
  Satisfy all
&lt;/Directory&gt;</PRE><P>
A request came for http://127.0.0.1/local/images.html would be
translated into this SPOCP query 
</P>
<PRE>(5:spocp
  (8:resource7:protect5:local11:images.html1:-)
  (6:action1:01:0)
  (7:subject(2:ip9:127.0.0.1)(4:host9:localhost))
)</PRE><P>
Which would be denied imeediately (given the simple ruleset above) 
</P>
<P>So we would have to change our rules to: 
</P>
<PRE>(5:spocp(8:resource4:docs)(6:action1:0)(7:subject))
(5:spocp(8:resource7:protect)(6:action1:0)(7:subject(2:ip9:127.0.0.1)(4:host9:localhost)))</PRE><P>
if we wanted to give the right people access to the resouce<BR>With
this ruleset in place the request would be granted since both the
access and the authorization queries would be matched by the same
rule (the second one).<BR>The queries would look like this: 
</P>
<PRE>(5:spocp
  (8:resource7:protect5:local11:images.html1:-)
  (6:action1:01:0)
  (7:subject(2:ip9:127.0.0.1)(4:host9:localhost))
)

(5:spocp
  (8:resource7:protect5:local11:images.html1:-)
  (6:action1:01:1)
  (7:subject
    (2:ip9:127.0.0.1)
    (4:host9:localhost)
    (4:user6:roland)
    (8:authname7:company)
    (8:authtype5:Basic)
  )
)</PRE><P>
Changing your rules again to: 
</P>
<PRE>(5:spocp(8:resource4:docs)(6:action1:0)(7:subject))
(5:spocp(8:resource7:protect)(6:action1:01:0)
  (7:subject(2:ip9:127.0.0.1)(4:host9:localhost)))
(5:spocp(8:resource7:protect)(6:action1:01:1)
  (7:subject(2:ip9:127.0.0.1)(4:host9:localhost)(4:user6:roland)))</PRE><P>
To separated the access control queries from the authorization
control queries, but also to explicitly specify who should be granted
access.<BR>'roland' with these rules in place would still be ganted
access to the page but 'eva' who has a valid user at the HTTP server
( and therefore would pass the first two checks, the access and
identity check) would not ( since she would fail on the authorization
check). 
</P>
</BODY>
</HTML>
